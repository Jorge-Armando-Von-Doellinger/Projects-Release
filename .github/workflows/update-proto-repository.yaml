name: Sync Proto Files

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  sync-protos:
    runs-on: ubuntu-latest

    steps:
    # Passo 1: Checkout do repositório de origem
    - name: Checkout Projects-Release repository
      uses: actions/checkout@v2
      with:
        repository: Jorge-Armando-Von-Doellinger/Projects-Release  # Substitua pelo nome correto do repositório
        ref: main  # Ou a branch de sua escolha

    # Passo 2: Navegar para o diretório correto e copiar arquivos .proto
    - name: Find and copy .proto files
      run: |
        # Navega para dois diretórios acima para garantir que estamos no local correto
        cd ..
        cd ..
        
        # Cria a pasta proto-files se não existir
        mkdir -p proto-files
        
        # Encontra e copia todos os arquivos .proto da pasta correta para proto-files
        find HMS/HMS.MicroServices -name "*.proto" -exec cp --parents {} proto-files/ \;

    # Passo 3: Checkout do repositório de destino grpc-proto-files
    - name: Checkout grpc-proto-files repository
      uses: actions/checkout@v2
      with:
        repository: Jorge-Armando-Von-Doellinger/grpc-proto-files  # Substitua pelo nome correto do repositório de destino
        token: ${{ secrets.GITHUB_TOKEN }}  # Para autenticação

    # Passo 4: Mover os arquivos copiados para o diretório final e commit no repositório de destino
    - name: Move proto files to target directory and commit
      run: |
        # Cria o diretório de destino, se não existir
        mkdir -p HMS/ProtoFiles 
        
        # Move todos os arquivos para o diretório correto
        mv proto-files/HMS/HMS.MicroServices/* HMS/ProtoFiles/ || echo "Nenhum arquivo para mover"

        # Verifica o status do Git antes de adicionar e comitar
        git status
        
        # Adiciona, comita e envia para o repositório de destino
        git add HMS/ProtoFiles/*
        git commit -m "Add new .proto files"
        git push origin main
